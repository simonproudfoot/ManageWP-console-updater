const axios=require("axios"),{prompt:prompt}=require("inquirer"),cliProgress=require("cli-progress");require("dotenv").config();const open=require("open"),MAINWP_DASHBOARD_URL=process.env.MAINWP_DASHBOARD_URL||"https://wpmanage.greenwich-design.co.uk",CONSUMER_KEY=process.env.WP_MANAGE_CONSUMER_KEY,CONSUMER_SECRET=process.env.WP_MANAGE_SECRET_KEY,GREEN="[32m",YELLOW="[33m",RED="[31m",RESET="[0m";function getColorForHealth(healthValue){return healthValue<=0?RED:healthValue>0&&healthValue<=50?YELLOW:GREEN}function getColorForSecurity(securityIssues){return 0===securityIssues?GREEN:securityIssues<5?YELLOW:RED}async function forceSiteSync(siteId){const endpoint=`${MAINWP_DASHBOARD_URL}/wp-json/mainwp/v1/site/sync-site`;try{const response=await axios.post(endpoint,null,{params:{consumer_key:CONSUMER_KEY,consumer_secret:CONSUMER_SECRET,site_id:siteId}});return console.log("Site sync initiated:",response.data),response.data}catch(error){return console.error(`Error syncing site ${siteId}:`,error.message),null}}async function purgeCache(siteId){const endpoint=`${MAINWP_DASHBOARD_URL}/wp-json/mainwp/v1/site/purge-cache`;try{const response=await axios.post(endpoint,null,{params:{consumer_key:CONSUMER_KEY,consumer_secret:CONSUMER_SECRET,site_id:siteId}});return console.log("Cache purge response:",response.data),response.data}catch(error){return console.error(`Error purging cache for site ${siteId}:`,error.message),null}}async function fetchSitesWithUpdates(){const endpoint=`${MAINWP_DASHBOARD_URL}/wp-json/mainwp/v1/sites/sites-available-updates-count`;try{const response=await axios.get(endpoint,{params:{consumer_key:CONSUMER_KEY,consumer_secret:CONSUMER_SECRET}});return response.data}catch(error){return console.error("Error fetching sites with updates:",error.message),null}}async function fetchSiteDetails(siteId){const endpoint=`${MAINWP_DASHBOARD_URL}/wp-json/mainwp/v1/site/site?site_id=${siteId}`;try{const response=await axios.get(endpoint,{params:{consumer_key:CONSUMER_KEY,consumer_secret:CONSUMER_SECRET}});return response.data}catch(error){return console.error(`Error fetching details for site ${siteId}:`,error.message),null}}async function updateWordPress(siteId){const endpoint=`${MAINWP_DASHBOARD_URL}/wp-json/mainwp/v1/site/site-update-wordpress`;try{const response=await axios.put(endpoint,null,{params:{consumer_key:CONSUMER_KEY,consumer_secret:CONSUMER_SECRET,site_id:siteId}});return response.data}catch(error){return console.error(`Error updating WordPress for site ${siteId}:`,error.message),null}}async function updatePlugins(siteId){const endpoint=`${MAINWP_DASHBOARD_URL}/wp-json/mainwp/v1/site/site-update-plugins`;try{const response=await axios.put(endpoint,null,{params:{consumer_key:CONSUMER_KEY,consumer_secret:CONSUMER_SECRET,site_id:siteId}});return console.log("Plugins update initiated:",response.data),response.data}catch(error){return console.error(`Error updating plugins for site ${siteId}:`,error.message),null}}async function waitForUpdateCompletion(siteId,updateType){const progressBar=new cliProgress.SingleBar({},cliProgress.Presets.shades_classic);for(progressBar.start(100,0);;){const siteDetails=await fetchSiteDetails(siteId);if(!siteDetails)return progressBar.stop(),void console.error("Failed to fetch site details");let progress=0;if("wordpress"===updateType)progress=siteDetails.wp_core_update?0:100;else if("plugins"===updateType){const totalPlugins=Object.keys(siteDetails.plugin_upgrades||{}).length;progress=0===totalPlugins?100:0}if(progressBar.update(progress),100===progress)return void progressBar.stop();await new Promise(resolve=>setTimeout(resolve,5e3))}}async function listWPManageSites(){for(;;){const sitesWithUpdates=await fetchSitesWithUpdates();sitesWithUpdates&&(console.log("\nSites with available updates:"),console.log(`WordPress: ${sitesWithUpdates.wordpress||0}`),console.log(`Plugins: ${sitesWithUpdates.plugins||0}`),console.log(`Themes: ${sitesWithUpdates.themes||0}`),console.log(`Total: ${sitesWithUpdates.total||0}`),console.log("-----------------------------------"));const sitesEndpoint=`${MAINWP_DASHBOARD_URL}/wp-json/mainwp/v1/sites/get-sites-by-url`;try{const response=await axios.get(sitesEndpoint,{params:{consumer_key:CONSUMER_KEY,consumer_secret:CONSUMER_SECRET,with_tags:2}}),sites=response.data;if("object"==typeof sites&&null!==sites){const choices=Object.entries(sites).map(([id,site])=>{const pluginUpdates=JSON.parse(site.plugin_upgrades||"{}"),pluginUpdateCount=Object.keys(pluginUpdates).length,wpUpgrades=JSON.parse(site.wp_upgrades||"[]"),hasCoreUpdate=wpUpgrades.length>0;let siteInfo={};try{siteInfo=JSON.parse(site.site_info||"{}")}catch(error){console.error(`Error parsing site_info for ${site.name}:`,error.message)}return{name:`${site.name}[0m - ${getColorForSecurity(site.securityIssues)}Security: ${site.securityIssues}[0m - ${getColorForHealth(site.health_value)}Health: ${site.health_value}%[0m - ${hasCoreUpdate?RED+"Core update":"[32mCore OK"}[0m - ${pluginUpdateCount>0?YELLOW:GREEN}Plugins: ${pluginUpdateCount}[0m`,value:{id:id,...site}}});choices.push({name:"Exit",value:"exit"});const{selectedSite:selectedSite}=await prompt({type:"list",name:"selectedSite",message:"Select a site to update or exit:",choices:choices,pageSize:100});if("exit"===selectedSite){console.log("Exiting...");break}console.log("\nFetching detailed information for",selectedSite.name);const siteDetails=await fetchSiteDetails(selectedSite.id);if(siteDetails){console.log("\nSite Details:"),console.log("Name:",selectedSite.name),console.log("URL:",selectedSite.url),console.log(`Security issues: ${getColorForSecurity(selectedSite.securityIssues)}${selectedSite.securityIssues}[0m`),console.log(`Site health: ${getColorForHealth(selectedSite.health_value)}${selectedSite.health_value}[0m`);let siteInfo={};try{siteInfo=JSON.parse(siteDetails.site_info||"{}")}catch(error){console.error("Error parsing site_info:",error.message)}console.log("WordPress Version:",siteInfo.wpversion||siteDetails.wp_version||"Unknown"),console.log("Debug Mode:",siteInfo.debug_mode?"Enabled":"Disabled"),console.log("PHP Version:",siteInfo.phpversion||siteDetails.phpversion||"Unknown"),console.log("MainWP Child Version:",siteInfo.child_version||"Unknown"),console.log("PHP Memory Limit:",siteInfo.memory_limit||"Unknown"),console.log("MySQL Version:",siteInfo.mysql_version||"Unknown"),console.log("cURL version:",siteInfo.child_curl_version||"Unknown"),console.log("OpenSSL version:",siteInfo.child_openssl_version||"Unknown"),console.log("Server IP:",siteInfo.ip||siteDetails.ip||"Unknown"),console.log("Last Check Status:",`${siteDetails.http_response_code} - ${"200"===siteDetails.http_response_code?"OK":"Error"}`),siteDetails.tags&&console.log("Tags:",siteDetails.tags);const{performUpdates:performUpdates}=await prompt({type:"confirm",name:"performUpdates",message:"Do you want to perform updates on this site?",default:!1});if(performUpdates){console.log("\nChecking and potentially updating WordPress core...");const wpUpdateResult=await updateWordPress(selectedSite.id);if(wpUpdateResult?(console.log("WordPress core update response:",wpUpdateResult),console.log("Attempting to purge cache..."),await purgeCache(selectedSite.id)):console.log("No WordPress core update was necessary or the update failed."),siteDetails.plugin_upgrades&&Object.keys(JSON.parse(siteDetails.plugin_upgrades)).length>0){console.log("\nInitiating plugins update...");const pluginUpdateResult=await updatePlugins(selectedSite.id);pluginUpdateResult?(console.log("Plugin update response:",pluginUpdateResult),console.log("Attempting to purge cache..."),await purgeCache(selectedSite.id)):console.log("Plugin update failed or no updates were necessary.")}else console.log("\nNo plugin updates available according to MainWP data.");console.log("\nForcing WP Manage to sync with the updated site..."),await forceSiteSync(selectedSite.id),console.log("Waiting for sync to complete..."),await new Promise(resolve=>setTimeout(resolve,1e4)),console.log("Fetching latest site details...");const updatedSiteDetails=await fetchSiteDetails(selectedSite.id);if(updatedSiteDetails){const siteInfo=JSON.parse(updatedSiteDetails.site_info||"{}");console.log("Current WordPress version:",siteInfo.wpversion||"Unknown");const pluginUpgrades=JSON.parse(updatedSiteDetails.plugin_upgrades||"{}");console.log("Current plugin updates available:",Object.keys(pluginUpgrades).length)}}}}else console.log("Unexpected response format. Raw data:"),console.log(JSON.stringify(sites,null,2))}catch(error){console.error("Error fetching WP Manage sites:",error.message),error.response&&(console.error("Response data:",error.response.data),console.error("Response status:",error.response.status))}}}listWPManageSites().then(()=>console.log("Script completed successfully.")).catch(error=>{console.error("An error occurred while running the script:"),console.error(error),process.exit(1)});